import { writeFile } from 'node:fs/promises'

import { decode } from 'fast-png'

import { generate, generatePng, generateQrCode } from '../src/index'

describe('QR Code as a PNG', () => {
  let data: Uint8Array | undefined = undefined

  it('should generate a PNG QR code for a simple message', async () => {
    const code = generateQrCode('foo')
    const png = await generatePng(code)
    const decoded = decode(png) // need to decode... deflate varies

    expect(Buffer.from(decoded.data).toString('hex').replaceAll('f', ' '))
        .toEqual([
          '                                                          ',
          '                                                          ',
          '                                                          ',
          '                                                          ',
          '        00000000000000        0000  00000000000000        ',
          '        00          00    00  00    00          00        ',
          '        00  000000  00  0000    00  00  000000  00        ',
          '        00  000000  00  00      00  00  000000  00        ',
          '        00  000000  00  00      00  00  000000  00        ',
          '        00          00  0000  00    00          00        ',
          '        00000000000000  00  00  00  00000000000000        ',
          '                        000000                            ',
          '        00  0000000000      0000    0000000000            ',
          '        00000000      00      00000000    00    00        ',
          '        0000000000  00  000000  00  0000  00  00          ',
          '          00          0000000000000000    0000  00        ',
          '        00  0000  0000    00    00    00      00          ',
          '                        00  00  00    00  00    00        ',
          '        00000000000000        00  00    0000  00          ',
          '        00          00  0000          0000  000000        ',
          '        00  000000  00  0000  00  00    00  00            ',
          '        00  000000  00  00    00000000    00              ',
          '        00  000000  00  00      00  0000                  ',
          '        00          00    000000000000    00              ',
          '        00000000000000  000000  00    00    0000          ',
          '                                                          ',
          '                                                          ',
          '                                                          ',
          '                                                          ',
        ].join(''))
  })

  it('should generate a PNG QR code', async () => {
    const png = await generate('https://www.juit.com/', 'png', { ecLevel: 'L', url: true, scale: 3, margin: 1 })
    const decoded = decode(png) // need to decode... deflate varies

    await writeFile('./test.png', png)

    expect(Buffer.from(decoded.data).toString('hex').replaceAll('f', ' '))
        .toEqual([
          '                                                                                                                                          ',
          '                                                                                                                                          ',
          '                                                                                                                                          ',
          '      000000000000000000000000000000000000000000                        000000000000      000000000000000000000000000000000000000000      ',
          '      000000000000000000000000000000000000000000                        000000000000      000000000000000000000000000000000000000000      ',
          '      000000000000000000000000000000000000000000                        000000000000      000000000000000000000000000000000000000000      ',
          '      000000                              000000                  000000      000000      000000                              000000      ',
          '      000000                              000000                  000000      000000      000000                              000000      ',
          '      000000                              000000                  000000      000000      000000                              000000      ',
          '      000000      000000000000000000      000000                  000000      000000      000000      000000000000000000      000000      ',
          '      000000      000000000000000000      000000                  000000      000000      000000      000000000000000000      000000      ',
          '      000000      000000000000000000      000000                  000000      000000      000000      000000000000000000      000000      ',
          '      000000      000000000000000000      000000      000000      000000                  000000      000000000000000000      000000      ',
          '      000000      000000000000000000      000000      000000      000000                  000000      000000000000000000      000000      ',
          '      000000      000000000000000000      000000      000000      000000                  000000      000000000000000000      000000      ',
          '      000000      000000000000000000      000000      000000000000      000000000000      000000      000000000000000000      000000      ',
          '      000000      000000000000000000      000000      000000000000      000000000000      000000      000000000000000000      000000      ',
          '      000000      000000000000000000      000000      000000000000      000000000000      000000      000000000000000000      000000      ',
          '      000000                              000000            000000      000000000000      000000                              000000      ',
          '      000000                              000000            000000      000000000000      000000                              000000      ',
          '      000000                              000000            000000      000000000000      000000                              000000      ',
          '      000000000000000000000000000000000000000000      000000      000000      000000      000000000000000000000000000000000000000000      ',
          '      000000000000000000000000000000000000000000      000000      000000      000000      000000000000000000000000000000000000000000      ',
          '      000000000000000000000000000000000000000000      000000      000000      000000      000000000000000000000000000000000000000000      ',
          '                                                                        000000000000                                                      ',
          '                                                                        000000000000                                                      ',
          '                                                                        000000000000                                                      ',
          '      000000000000                  000000000000000000                  000000                        000000000000                        ',
          '      000000000000                  000000000000000000                  000000                        000000000000                        ',
          '      000000000000                  000000000000000000                  000000                        000000000000                        ',
          '      000000            000000000000000000                  000000      000000000000            000000                                    ',
          '      000000            000000000000000000                  000000      000000000000            000000                                    ',
          '      000000            000000000000000000                  000000      000000000000            000000                                    ',
          '                                          000000000000      000000000000            000000      000000000000                  000000      ',
          '                                          000000000000      000000000000            000000      000000000000                  000000      ',
          '                                          000000000000      000000000000            000000      000000000000                  000000      ',
          '                              000000            000000      000000000000      000000000000                  000000000000000000            ',
          '                              000000            000000      000000000000      000000000000                  000000000000000000            ',
          '                              000000            000000      000000000000      000000000000                  000000000000000000            ',
          '      000000000000000000000000      000000000000      000000            000000      000000000000000000000000000000      000000000000      ',
          '      000000000000000000000000      000000000000      000000            000000      000000000000000000000000000000      000000000000      ',
          '      000000000000000000000000      000000000000      000000            000000      000000000000000000000000000000      000000000000      ',
          '                                                      000000000000                  000000000000            000000000000000000000000      ',
          '                                                      000000000000                  000000000000            000000000000000000000000      ',
          '                                                      000000000000                  000000000000            000000000000000000000000      ',
          '      000000000000000000000000000000000000000000      000000000000      000000      000000            000000000000000000      000000      ',
          '      000000000000000000000000000000000000000000      000000000000      000000      000000            000000000000000000      000000      ',
          '      000000000000000000000000000000000000000000      000000000000      000000      000000            000000000000000000      000000      ',
          '      000000                              000000      000000                        000000      000000000000000000000000                  ',
          '      000000                              000000      000000                        000000      000000000000000000000000                  ',
          '      000000                              000000      000000                        000000      000000000000000000000000                  ',
          '      000000      000000000000000000      000000                  000000000000000000000000                        000000      000000      ',
          '      000000      000000000000000000      000000                  000000000000000000000000                        000000      000000      ',
          '      000000      000000000000000000      000000                  000000000000000000000000                        000000      000000      ',
          '      000000      000000000000000000      000000                  000000000000      000000      000000      000000000000                  ',
          '      000000      000000000000000000      000000                  000000000000      000000      000000      000000000000                  ',
          '      000000      000000000000000000      000000                  000000000000      000000      000000      000000000000                  ',
          '      000000      000000000000000000      000000            000000000000                  000000            000000      000000000000      ',
          '      000000      000000000000000000      000000            000000000000                  000000            000000      000000000000      ',
          '      000000      000000000000000000      000000            000000000000                  000000            000000      000000000000      ',
          '      000000                              000000      000000            000000            000000000000            000000      000000      ',
          '      000000                              000000      000000            000000            000000000000            000000      000000      ',
          '      000000                              000000      000000            000000            000000000000            000000      000000      ',
          '      000000000000000000000000000000000000000000      000000                  000000      000000      000000000000                        ',
          '      000000000000000000000000000000000000000000      000000                  000000      000000      000000000000                        ',
          '      000000000000000000000000000000000000000000      000000                  000000      000000      000000000000                        ',
          '                                                                                                                                          ',
          '                                                                                                                                          ',
          '                                                                                                                                          ',
        ].join(''))

    // used for the data URL test
    data = png
  })

  it('should generate a PNG QR code as a data URL', async () => {
    if (! data) return skip()

    const png = await generate('https://www.juit.com/', 'pngData', { ecLevel: 'L', url: true, scale: 3, margin: 1 })
    expect(png).toMatch(/^data:image\/png;base64,/)

    expect(new Uint8Array(Buffer.from(png.substring(22), 'base64'))).toEqual(data)
  })
})
